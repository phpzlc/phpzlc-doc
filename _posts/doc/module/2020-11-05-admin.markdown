---
title: 后台内核(Admin)
permalink: doc/module/admin
author_no: 2
prev_page: /doc/module/vendor
next_page: /doc/module/upload
description_auto: 0
description: 后台内核,为后台业务提供底层策略,写法支持.(导航菜单,基础页面)
tags: admin,phpzlc/admin,后台
---

## 业务介绍

后台内核,为后台业务提供底层策略,写法支持.(导航菜单,基础页面,导入,导出等功能)

## 源码地址

[phpzlc/admin](https://github.com/phpzlc/admin)

## 安装

```shell 
composer require phpzlc/admin
```

## 服务引入

   后台控制器需要按照下列来实现基类
   
```php
class AdminController extends SystemBaseController
      {
          /**
           * @var AdminStrategy
           */
          private $adminStrategy;
      
          /**
           * @var string
           */
          private $pageTag;
          
          public function inlet($returnType = SystemBaseController::RETURN_HIDE_RESOURCE, $isLogin = true)
          {
              $this->adminStrategy = new AdminStrategy($this->container);
              $this->adminStrategy->setPageTag($this->pageTag);
              
              return parent::inlet($returnType, $isLogin);
          }
      }
```


## AdminStrategy

   是后台核心机制类,主要用于设置后台系统的基本属性和动作
   
```php

 //菜单配置
$menus = [
    new Menu($title, $ico, $tag, $url, $url_target, [
    new Menu($title, $ico, $tag, $url, $url_target, $childs = array())
    ])
];           
    
$this->adminStrategy = new AdminStrategy($this->container);
    
//设置管理端基本信息(名称,页面标记,菜单......)
$this->adminStrategy
    // 设置后台标题
    ->setTitle('admin')
    // 设置后台入口URL
    ->setEntranceUrl($this->generateUrl('admin_manage_index'))
    // 设置后台退出登录URL
    ->setEndUrl($this->generateUrl('admin_manage_logout'))
    // 设置修改密码页面URL
    ->setSettingPwdUrl($this->generateUrl('admin_manage_edit_password'))
    // 设置后台页面模式
    ->setMenuModel(AdminStrategy::menu_model_simple)
    // 设置页面标记
    ->setPageTag($this->page_tag)
    // 设置清除缓存API地址url
    ->setClearCacheApiUrl($this->generateUrl('admin_manage_clearCache'))
    // 设置后台favicon_ico图标
    ->setFaviconIco('public/image/100.png')
    // 设置后台logo
    ->setLogo('public/image/200.png')
    // 设置后台导航菜单
    ->setMenus($menus)
    // 设置登陆页面背景图片
    ->setLoginLackGroundImg('public/image/200.png');
```

1. 设置锚点url
   
   用于设置表单提交,取消等需要返回到某个控制器层的action中时,我们可以使用该方法,将action设为锚点,一般在列表中设置
   
    ```php
    public function setUrlAnchor()
    ```
   
2. 设置页面标记
   
    页面标记配置，需要和菜单配置相对应，用于菜单选项的高亮显示。
   
   ```php
   public function setPageTag($tag)
   ```

3. 设置后台标题
   
   ```php
   public function setTitle($title)
   ```

4. 设置后台favicon_ico图标
    
   ```php
   public function setFaviconIco($favicon_ico)
   ```

5. 设置后台logo
    
   ```php
   public function setLogo($logo)
   ```

6. 设置后台入口URL
   
   $entrance_url 可以使用$this->generateUrl(string $route)方法进行生成,$route是在yaml中设置的路由名称

   ```php
   public function setEntranceUrl($entrance_url)
   ```
   
7. 设置退出登录URL
    
   ```php
   public function setEndUrl($end_url)
   ```

8. 设置密码修改页面url
   
   ```php
   public function setSettingPwdUrl($setting_pwd_url)
   ```

9. 设置清除缓存API地址url
   
   $clear_cache_api_url 可以使用$this->generateUrl(string $route)方法进行生成,$route是在yaml中设置的路由名称

   ```php
   public function setClearCacheApiUrl(string $clear_cache_api_url)
   ```

10. 设置管理员角色名称
   
   ```php
   public function setAdminRoleName($admin_role_name)
   ```
   
1 1. 设置登陆页面背景图片
   
   ```php
   public function setLoginLackGroundImg(string $login_lack_ground_img)
   ```
   
1 2. 设置管理员登录头像

   ```php
   public function setAdminAvatar(string $admin_avatar)
   ```

1 3. 设置head自定义代码

   ```php
   public function setHendCode(string $hend_code)
   ```

## 面包线配置

   在需要设置面包线的页面调用此方法,我们提供了两种不同模式的面包线的设置方法
        
1. 初始化面包线
         
   ```php
   $this->adminStrategy->setNavigations(array $navigations)
   ```

2. 在原有的面包线上添加面包线
     
   ```php
   $this->adminStrategy->addNavigation(new Navigation($title, $url = ''));
   ```
   
## 模式切换

   本框架提供两种后台页面模式.这两种模式可以进行切换,适合不同量级的后台.
   
1. 简单模式(三级菜单,后期可升级为复杂模式)

2. 复杂模式(四级菜单,增加头部菜单,功能划分更精确直观)
      
   ```php
   $this->adminStrategy = new AdminStrategy(ContainerInterface $container);
   $this->adminStrategy->setMenuModel(AdminStrategy::menu_model_simple) // 简单模式 menu_model_simple; 复杂模式 menu_model_all; 
   ```
   
3. 页面效果
   
   简单模式效果
   
   ![简单模式](/assets/posts/admin/model_simple.png)
   
   复杂模式效果
   
   ![复杂模式](/assets/posts/admin/model_all.png)
   
## 设置导航菜单   
   
1. 我们将要显示的导航菜单根据它的层级设置一个多维数组$menus,然后调用
   
   ```php
   $this->adminStrategy->setMenus(array $menus);
   ```
   
2. 比较常用三级层级的导航菜单
   
   ```php
   new Menu('博客管理系统', null, null, null, null, [
          new Menu('博客管理', 'fa fa-clone', null, null, null, [
              new Menu('文章管理', null, 'admin_article_index', $this->generateUrl('admin_blog_manage_article_index'), null),
          ]),
      
   ]);
   ```

## 页面技术栈

   [Vue.js](https://cn.vuejs.org/)
    
   [ElementUI](https://element.eleme.io/#/zh-CN/component/installation)
    
   [Twig](https://www.kancloud.cn/yunye/twig-cn/159454)
    
   [Font图表库](https://fontawesome.dashgame.com/)
    
## 仪表盘基本写法
   
   完整页面请进入[代码参考模板](https://github.com/phpzlc/demo-blog/blob/master/templates/page/statistical-station.html.twig)
   
   页面要先引用
   
   ![引用](/assets/posts/admin/echart.png)
   
1. 数据统计框
   
```vue
   <div class="console-small-statistics clearfix">
       <a :class="'console-small-statistics-bg'+(index+1)"
           v-for="(item, index) in consoleSmall" :key="index" :href= "item.src" style="margin-left: 40px">
            <p class="console-statistics-name">${item.name}$:</p>
             <p class="console-statistics-value">${item.value}$</p>
        </a>
   </div>
   ```
   
```shell script
    data: function () {
             return {
                  consoleSmall: [
                     {
                         id: '',
                         name: '',
                         value: '',
                         src: ''
                     },
                       
                  ],
             }
    },
   ```
  
2. 数据统计表
   
   ```vue
   <div class="echarts-content clearfix">
            <el-col>
                <el-col :span="12">
                    <div id="main1" style="width: 100%;height:400px;">
                    </div>
                    <span style="position: absolute; margin-left: 365px; margin-top: -30px; z-index: 100; font-size: 16px">最近七日博客数增长图</span>
                </el-col>

                <el-col :span="12">
                    <div id="main2" style="width: 100%;height:400px;"></div>
                    <span style="position: absolute; margin-left: 365px; margin-top: -30px; z-index: 100; font-size: 16px">最近七日用户数增长图</span>

                </el-col>
            </el-col>

   </div>
   ```
   
   ```shell script
   setTimeout(function(){
               // 基于准备好的dom,初始化echarts实例
               var myChart1 = echarts.init(document.getElementById('main1'), "macarons");
               option1 = {
                   xAxis: {
                       type: 'category',
                       boundaryGap: false,
                       data: [],
                   },
                   yAxis: {
                       type: 'value'
                   },
                   series: [{
                       data: [],
                       type: 'line',
                       areaStyle: {}
                   }]
               };
               // 使用刚指定的配置项和数据显示图表.
               myChart1.setOption(option1);
   ```

3. 页面效果
   
   ![效果](/assets/posts/admin/data.png)

   
## 列表页面基本写法
   
   
   完整页面请进入[代码参考模板](https://github.com/phpzlc/demo-blog/blob/master/templates/page/list.html.twig)
   
1. 搜索框
   
   ```vue
       <el-row class="page-search">
           <el-form ref="searchForm" :inline="true" :model="searchForm" label-width="90px" style="margin-left: 10px">
   
               <el-form-item label="input输入框" prop="user_name">
                   <el-input v-model="searchForm.user_name" size="mini" clearable placeholder="请输入">
                   </el-input>
               </el-form-item>
   
               <el-form-item label="时间选择框" prop="login_at" class="search-item-time">
                   <el-date-picker v-model="searchForm.login_at" size="mini" clearable type="daterange"
                                   range-separator="-" start-placeholder="开始日期" end-placeholder="结束日期">
                   </el-date-picker>
               </el-form-item>
   
               <el-form-item>
                   <el-button type="primary" size="mini" @click="searchBtn()"> 搜索 </el-button>
                   <el-button size="mini" @click="resetForm('searchForm')"> 重置 </el-button>
               </el-form-item>
   
           </el-form>
   
       </el-row>
       
   ```
   
2. 数据显示
   
   ```vue
        <el-table :data="listData" style="width: 100%" border class="mt-10">
    
            <el-table-column prop="数据" label="数据"></el-table-column>
            // 操作行
            <el-table-column prop="date" label="操作" width="200">
                <template slot-scope="scope">
                    <el-button size="mini" @click="handleEdit(scope.$index, scope.row)" type="primary"> 编辑 </el-button>
                    <el-button size="mini" @click="handleDelete(scope.$index, scope.row)" type="danger"> 删除 </el-button>
                    <el-button size="mini" @click="handleDisable(scope.$index, scope.row)" type="danger"> 禁用 </el-button>
                    <el-button size="mini" @click="handleEnable(scope.$index, scope.row)" type="success"> 启用 </el-button>
                </template>
            </el-table-column>
          
        </el-table>
   
        // 分页
        <el-col class="mt-20 clearfix">
            <el-pagination class="page" @current-change="handleCurrentChange" @size-change="handleSizeChange"
                           :page-sizes="[20, 60, 100, 200]" :page-size="" :hide-on-single-page="true" :current-page=""
                           layout="total, sizes, prev, pager, next, jumper" :total="">
            </el-pagination>
        </el-col>
   ```
   
3. Vue代码模块
   
   ```shell script
   <script>
       new Vue({
           el: '#main-content',
           //用于替换vue数据调用符号
           delimiters: ['${', '}$'],
           data: function () {
               return {
                   searchForm: {},
                   listData: [],
               }
           },
   
           created(){
               //页面初始化勾子
           },
   
           methods: {
                   handleCurrentChange(val) {
                       window.location.href = urlParamWrite(getSelfUrl(), 'page', val);
                   },
   
                   handleSizeChange(val) {
                       window.location.href = urlParamWrite(getSelfUrl(), 'rows', val);
                   },
   
                   // 搜索按钮
                   searchBtn() {},
   
                   // 重置按钮
                   resetForm(formName){
                       this.$refs[formName].resetFields();
                   },
   
                   handleDisable(index, row){},
   
                   handleEnable(index, row){},
   
           }
   
       })
   </script>
   ```
4. 页面效果
   
   ![效果](/assets/posts/admin/index.png)
   
## 编辑页面基本写法
  
   
   完整页面请进入[代码参考模板](https://github.com/phpzlc/demo-blog/blob/master/templates/page/edit.html.twig)
   
1. 输入框(文本输入,密码输入等多种类型)
   
   ```vue
     <el-input v-model="" size="mini" clearable placeholder="请输入"></el-input>
   ```
   
2. 下拉单选框
   
   ```vue
    <el-select v-model="value" placeholder="请选择">
        <el-option
          v-for="item in options"
          :key="item.value"
          :label="item.label"
          :value="item.value">
        </el-option>
    </el-select>
   
    <script>
      export default {
        data() {
          return {
            options: [],
          }
        }
      }
    </script>
   ```
   
3. 下拉多选框
   
   ```vue
    <el-select v-model="value" multiple placeholder="请选择">
            <el-option
              v-for="item in options"
              :key="item.value"
              :label="item.label"
              :value="item.value">
            </el-option>
          </el-select>
       
    <script>
          export default {
            data() {
              return {
                options: [],
              }
            }
          }
    </script>
   ```
4. 上传控件
   
   ```vue
    <el-upload
      class="upload-demo"
      action=""
      :on-preview="handlePreview"
      :on-remove="handleRemove"
      :before-remove="beforeRemove"
      multiple
      :limit="3"
      :on-exceed="handleExceed"
      :file-list="fileList">
      <el-button size="small" type="primary">点击上传</el-button>
      <div slot="tip" class="el-upload__tip">只能上传jpg/png文件,且不超过500kb</div>
    </el-upload>
   
    <script>
      export default {
        data() {
          return {
            fileList: []
          };
        },
        methods: {
          handleRemove(file, fileList) {
            console.log(file, fileList);
          },
          handlePreview(file) {
            console.log(file);
          },
          handleExceed(files, fileList) {
            this.$message.warning(`当前限制选择 3 个文件,本次选择了 ${files.length} 个文件,共选择了 ${files.length + fileList.length} 个文件`);
          },
          beforeRemove(file, fileList) {
            return this.$confirm(`确定移除 ${ file.name }？`);
          }
        }
      }
    </script>
   ```
5. 日期选择器
   
   ```vue
   <el-date-picker
         v-model="value1"
         type="daterange"
         range-separator="至"
         start-placeholder="开始日期"
         end-placeholder="结束日期">
   </el-date-picker>
   <script>
     export default {
       data() {
         return {
           value1: ''
         };
       }
     };
   </script>
   ```
   
6. 单选框
   
   ```vue
   <el-radio v-model="radio" label="1">备选项</el-radio>
     
   <script>
     export default {
       data () {
         return {
           radio: ''
         };
       }
     }
   </script>
   ```   
   
7. 多选框
   
   ```vue
    <!-- `checked` 为 true 或 false -->
   <el-checkbox v-model="checked">备选项</el-checkbox>
   
   <script>
     export default {
       data() {
         return {
           checked: true
         };
       }
     };
   </script>
   ```
   
   更多控件请进入[ElementUI](https://element.eleme.io/#/zh-CN/component/input)
   
   
## 导入功能基本写法

   导入导出功能需要[phpoffice/phpspreadsheet](https://packagist.org/packages/phpoffice/phpspreadsheet)
   
   ```text
   composer require phpoffice/phpspreadsheet
   ```
   
   **页面层**
   
   ```vue
    <el-upload
          class="upload-demo"
          action="导入地址"
          :limit="1"
          :on-success="handleImport"
          :on-error = "handleImport"
          :file-list="fileList">
          <el-button size="small" type="primary">点击上传</el-button>
          <div slot="tip" class="el-upload__tip">只能上传xls/xlsx文件</div>
    </el-upload>
    
    <script>
          export default {
            methods: {
              handleImport(result){
                  const that = this;
                  resultPreprocess(that, result, "admin_url_anchor()");
              },
            }
          }
    </script>
   ```

   **控制器层**
   
1. 下载导入模板
   
   ```php
    // Business层
    public function importTemplateFilePath()
    {
            return '模板名称.xlsx';
    }
    
    public function downloadImportTemplate(Request $request)
    {
       $this->goUrl($request->getSchemeAndHttpHost() . $request->getBasePath() . '/存放导入文件的文件夹/' . $this->importTemplateFilePath());
    }

    // Controller层
    $Business  = new Business($this->container);
    $Business->goUrl($Business->downloadImportTemplate(Request $request));
   ```
   
2. 导入模板
   
   ```php
   // Business层
   public function format($data)
       {
           if(empty($data)){
               throw new PhpZlcApiException('导入数据不能为空');
           }
   
           $info = [];
         
           foreach ($data as $index => $value){
               $name = $this->getValue($value, 0);
            
               $info[] = array(
                   'name' => $name
               );
  
           }
           return $info;
       }
   // Controller层
   set_time_limit(0);
   ob_start();
   
   $Business  = new Business($this->container);
   
   /**
      * @var Connection $conn
   */
   $conn = $this->getDoctrine()->getConnection();
   $conn->beginTransaction();
   
   try {
        $data = $Business->importData();
   
        foreach ($data as $k => $v) {
           // 将$data的数据循环插入
           $conn->commit();
        }
   
        return Responses::success('导入成功');
   
   }catch (PhpZlcApiException $exception){
        $conn->rollBack();
        return Responses::error($exception->getMessage());
   }
   ```
   
## 导出功能基本写法

   **页面层**
   
   ```vue
   <el-button size="mini" type="success" @click="export_data()">导出</el-button>

    <script>
       export default {
          methods: {
            export_data(){
              window.location.href = urlParamWrite(getSelfUrl(), 'ex', '1');
           },
          }
       }
       </script>
   ```
   **控制器层**
   
   ```php
    use PHPZlc\Admin\Strategy\Excel\Export;

    $ex = new Export();

    // 表格第一行
    $head = [];
    // 数据库数据
    $list = array();

    $data = [];
    
    foreach ($list as $value){
         $data[] = array(
          // 循环的数据
        );
    }
    
    /**
        * 导出
        *
        * @param string $title  标题
        * @param array $head 表头 ["表头1", "表头2"]
        * @param array $data 内容 [{"1", "1"}]
        * @param bool $is_need 是否插入序号
        * @param array $mergeCells 合并单元格 [{0,1,0,2})] 0,1 表示合并开始单元格数组坐标, 0,2 代表合并结束单元格数组坐标
        * @param string $format
        * @throws \PhpOffice\PhpSpreadsheet\Exception
    */
   $ex->export($title, $head, $data, $is_need = false, $mergeCells = array(), $format = 'Xls');
   ```

    
