---
title: Symfony 5.4 变化：控制器中弃用快捷方式引用服务
permalink: /blog/26.html
description_auto: 0
description: 不要在控制器中使用快捷方式，而是在构造函数或控制器方法中注入相关服务。
tags: phpzlc,symfony,开源社区
author_no: 1
img_all: 1
---

## 前言

Symfony 控制器是“胶水代码”，它运行一些逻辑并调用一些服务来为每个应用程序路由提供服务。它们是非常稳定的软件，我们很少更改。但是，在 Symfony 5.4 中，我们对控制器进行了一些更改，这些更改可能会影响您的应用程序。

## 弃用 Request::get() 方法

所述的Symfony请求对象是HTTP请求消息的面向对象的表示。这个对象提供了几种方法来从传入的请求中获取信息：

```php
// retrieve information from $_GET
$request->query->get('id');
// retrieve information from $_POST
$request->request->get('category', 'default category');
// retrieve information from $_SERVER
$request->server->get('HTTP_HOST');
// retrieve information from $_COOKIE
$request->cookies->get('PHPSESSID');
```

除了这些特定方法之外，还有一个通用get()方法可以在路径（路由占位符或自定义属性）$_GET、 和中查找信息，$_POST并返回找到的第一个值：

```php
// this information could come from route attributes, from $_GET or form $_POST
$request->get('id');
```

这种方法的灵活性在某些边缘情况下可能很有用，但通常最好明确说明数据的来源。这就是为什么我们多年来一直不鼓励使用这种方法，并且在 Symfony 5.4 中我们将其标记为私有。您仍然可以使用它，但如果这样做，您会看到弃用消息，因此最好开始升级您的应用程序。

## 弃用了一些控制器快捷方式

扩展的控制器`AbstractController`可以直接通过`get()`和`has()`方法直接获取服务。这些方法让开发者认为他们可以访问整个容器，这是不正确的。此外，有限的服务集是快捷方式所需的服务，不是每个人必须使用的服务。

在早期的 Symfony 版本中，您可以使用get()和has()方法从控制器访问所有应用程序服务：

```php
// src/Controller/SomeController.php
namespace App\Controller;

use Symfony\Bundle\FrameworkBundle\Controller\AbstractController;
use Symfony\Component\HttpFoundation\Response;
use Symfony\Component\Routing\Annotation\Route;

class SomeController extends AbstractController
{
    #[Route(...)]
    public function someAction(): Response
    {
        $doctrine = $this->get('doctrine');
        // ...
    }
}
```

后来我们去掉了这个特性，因为以这种方式访问整个服务容器被认为是一种反模式。因此，该get()方法只允许访问与控制器相关的非常有限的一组服务。

在 Symfony 5.4 中，我们完全弃用了get()和has()方法。相反，在控制器中获取服务应该使用构造函数或方法注入。此外，控制器为最常见的操作提供了一系列快捷方式。例如，要重定向到某个路由，您不需要注入`UrlGeneratorInterface`该类来获取 URL 生成器服务。您可以选择使用`redirectToRoute()`快捷方式：

```php
#[Route(...)]
public function someAction(): Response
{
    // ...

    return $this->redirectToRoute('...');
}
```

除了此更改之外，我们还查看了快捷方式列表，以确定是否应该添加或删除一些快捷方式。我们决定弃用以下控制器快捷方式，因为它们与 HTTP 操作没有直接关系：

```php
dispatchMessage()
getDoctrine()
```

不要使用这些快捷方式，而是在构造函数或控制器方法中注入相关服务。

## 对应解决方法

如果仍然使用容器，可以通过$this->container属性访问它（例如getSubscribedServices()）。[#42442](https://github.com/symfony/symfony/pull/42442)

## 原文链接

[Symfony 5.4 新功能：控制器变化](https://symfony.com/blog/new-in-symfony-5-4-controller-changes)