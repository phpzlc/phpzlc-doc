<html lang="en">

<head>
  <title>PHPZlc & Symfony4+ 高级查询</title>
  <!-- Meta -->
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="baidu-site-verification" content="code-OoCu9VCIRn" />
  <meta name="baidu-site-verification" content="code-h0wILViqaf" />
  <meta name="baidu-site-verification" content="code-6w6tR8FnFh" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="高级查询">
  <meta name="keywords" content="symfony,phpzlc,查询">
  <meta name="author" content="CJayHe">
  <link rel="shortcut icon" href="/assets/favicon.ico" type="image/x-icon">
  <link
    href='/assets/css/fonts.googleapis.com.css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800'
    rel='stylesheet' type='text/css'>

  <!-- <script type="text/javascript" src="/assets/plugins/jquery-3.4.1.min.js"></script> -->
  <script src="/assets/plugins/jquery.js"></script>
  <!-- FontAwesome JS -->
  <script defer src="/assets/fontawesome/js/all.js"></script>
  <script src="/assets/author.js"></script>
  <!-- Global CSS -->
  <link rel="stylesheet" href="/assets/plugins/bootstrap/css/bootstrap.min.css">
  <!-- Plugins CSS -->
  <link rel="stylesheet" href="/assets/plugins/prism/prism.css">
  <link rel="stylesheet" href="/assets/plugins/elegant_font/css/style.css">
  <!-- Theme CSS -->
  <link id="theme-style" rel="stylesheet" href="/assets/css/styles.css">
  <link rel="stylesheet" href="/assets/css/main.css?v=2020">
  <link rel="stylesheet" href="/assets/css/reward.css">
  <script>
    var _hmt = _hmt || [];
    (function () {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?4d26e6c3f68c2a83660fb0f8968e60c3";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>

</head>

<body class="body-blue">
<div class="page-wrapper">
    <header id="header" class="header">
  <div class="container">
    <div class="branding">
      <h1 class="logo">
        <a href="/">
          <span aria-hidden="true" class="icon_documents_alt icon"></span>
          <span class="text-highlight">PHPZLC</span><span class="text-bold">Docs</span>
        </a>
      </h1>
    </div>
    <!--//branding-->
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="/">首页</a></li>
      <li class="breadcrumb-item active">文档支持</li>
    </ol>
    <div class="top-search-box">
      <form class="form-inline search-form justify-content-center" action="/search" method="get">

        <input type="text" placeholder="搜索..." name="search" class="form-control search-input" id="search-input">
        <button type="submit" class="btn search-btn" value="Search"><i class="fas fa-search"></i></button>
      </form>
    </div>
  </div>
  <!--//container-->
</header>
<!--//header-->
    <div class="doc-wrapper">
        <div class="container">
            <div class="doc-body row">
                <style type="text/css">
  html {
    font-size: 62.5%;
  }

  #left-div {
    border-width: 2px;
    width: 250px;
    float: left;
    margin-right: 20px;
    /* font-family: Georgia, serif; */
    font-family: "Helvetica Neue", Helvetica, Arial, "PingFang SC", "Hiragino Sans GB", "Heiti SC", "Microsoft YaHei", "WenQuanYi Micro Hei", sans-serif;
  }

  /* 导航 */
  .nav {
    margin-top: 15px;
  }

  .nav-back {
    display: none;
  }

  .nav-ul-one .nav-li-one {
    list-style: none;
  }

  .nav-ul-one .nav-li-one a {
    display: block;
    font-size: 16px;
    line-height: 30px;
    color: #494d55;
    text-decoration: none;
  }

  .nav-ul-one .nav-li-one a:hover {
    color: #00adef;
  }

  .nav-ul-two {
    padding-left: 20px;
  }

  .nav-ul-two .nav-li-two {
    padding: 0;
    list-style: none;
  }

  .nav-ul-two .nav-li-two a {
    font-size: 14px;
    font-weight: normal;
    line-height: 30px;
    /* color: #2d8284; */
    color: #494d55;
    opacity: 0.75;
  }

  .nav-ul-two .nav-li-two a:hover {
    color: #00adef;
  }

  .nav-hidden {
    display: none;
  }

  .nav-ul-one .nav-li-one .a-active {
    color: #00adef;
  }

  /* 移动端样式 */
  @media (max-width: 1199px) {
    .nav {
      position: fixed;
      top: 0;
      right: 100%;
      z-index: 10;
      width: 100%;
      height: 100%;
      margin: 0;
      /* background-color: #494d55ab; */
      background-color: rgba(0, 0, 0, 0.5);
      overflow-y: auto;
      transition: 0.2s linear;
    }

    .nav-back {
      display: block;
      width: 70%;
      padding-left: 2%;
      background: #494d55;
    }

    .nav-back a {
      display: block;
      padding-left: 20px;
      font-size: 1.6rem;
      font-weight: 700;
      line-height: 4rem;
      color: #fff;
      background: url("/assets/images/pro-2.png") no-repeat left center;
    }

    .nav-ul-one {
      padding-top: 1rem;
      padding-left: 3%;
      margin: 0;
      width: 70%;
      background: #f9f9fb;
    }

    .nav-ul-one .nav-li-one a {
      margin-left: 6%;
    }

    .nav-hidden {
      position: fixed;
      left: -1.5rem;
      top: 17rem;
      z-index: 5;
      display: block;
      width: 3rem;
      height: 3rem;
      opacity: 0.5;
      border-radius: 10%;
      padding-left: 1.5rem;
      background: #000 url("/assets/images/pro.png") no-repeat 90% center;
    }
  }
</style>
<div id="left-div">
  <div class="nav-hidden"></div>
  <!-- 导航 -->
  <div class="nav">
    <div class="nav-back"><a href="javascript:;">返回</a></div>
    <ul class="nav-ul-one">
      <li class="nav-li-one"><a href="/doc/install">安装与运行</a></li>
      <li class="nav-li-one"><a href="/doc/skeleton">目录与结构</a></li>
      <li class="nav-li-one">
        <a href="/doc/config/params#">配置</a>
        <ul class="nav-ul-two">
          <li class="nav-li-two"><a href="/doc/config/params">常量参数配置与环境配置</a></li>
          <li class="nav-li-two"><a href="/doc/config/route">路由(Router)</a></li>
        </ul>
      </li>
      <li class="nav-li-one">
        <a href="/doc/controller#">控制器</a>
        <ul class="nav-ul-two">
          <li class="nav-li-two"><a href="/doc/controller">控制器(Controller)</a></li>
          <li class="nav-li-two"><a href="/doc/errors">错误收集(Errors)</a></li>
          <li class="nav-li-two"><a href="/doc/validate">验证(Validate)</a></li>
        </ul>
      </li>
      <li class="nav-li-one">
        <a href="/doc/db/start#">数据库</a>
        <ul class="nav-ul-two">
          <li class="nav-li-two"><a href="/doc/db/start">创建使用数据库</a></li>
          <li class="nav-li-two"><a href="/doc/db/entity">设计Entity</a></li>
          <li class="nav-li-two"><a href="/doc/db/edit">插入、更新、删除</a></li>
          <li class="nav-li-two"><a href="/doc/db/query">简单查询</a></li>
        </ul>
      </li>
      <li class="nav-li-one">
        <a href="/doc/business#">业务层</a>
        <ul class="nav-ul-two">
          <li class="nav-li-two"><a href="/doc/business">业务层(Business)</a></li>
          <li class="nav-li-two"><a href="/doc/tool/sql">工具类-SQL</a></li>
          <li class="nav-li-two"><a href="/doc/tool/log">工具类-Log</a></a></li>
          <li class="nav-li-two"><a href="/doc/exception">异常(Exception)</a></li>
        </ul>
      </li>
      <li class="nav-li-one">
        <a href="/doc/repository#">高级查询(Repository)</a>
        <ul class="nav-ul-two">
          <li class="nav-li-two"><a href="/doc/repository">概述</a></li>
          <li class="nav-li-two"><a href="/doc/repository/rule">规则</a></li>
          <li class="nav-li-two"><a href="/doc/repository/rule-advanced-usage">规则-高级用法</a></li>
        </ul>
      </li>
      <li class="nav-li-one">
        <a href="/doc/symfony-flex#">支持配套</a>
        <ul class="nav-ul-two">
          <li class="nav-li-two"><a href="/doc/symfony-flex">Symfony Flex</a></li>
          <li class="nav-li-two"><a href="/doc/document-bundle">文档书写(Document)</a></li>
          <li class="nav-li-two"><a href="/doc/data-fixtures">内置数据(DataFixtures)</a></li>
        </ul>
      </li>
      <li class="nav-li-one">
        <a href="/doc/module/business#">业务组件(Business Package)</a>
        <ul class="nav-ul-two">
          <li class="nav-li-two"><a href="/doc/module/business">概述</a></li>
          <li class="nav-li-two"><a href="/doc/module/admin-business">后台开发</a></li>
          <li class="nav-li-two"><a href="/doc/module/RBAC-business">RBAC权限</a></li>
          <li class="nav-li-two"><a href="/doc/module/auth-business">登录授权</a></li>
          <li class="nav-li-two"><a href="/doc/module/platform-business">平台标识</a></li>
          <!--          <li class="nav-li-two"><a href="/doc/module/sms-business">短信(SMS)</a></li>-->
          <li class="nav-li-two"><a href="/doc/module/captcha-business">图形验证码</a></li>
          <li class="nav-li-two"><a href="/doc/module/upload-business">上传业务</a></li>
        </ul>
      </li>
      <li class="nav-li-one">
        <a href="/doc/module/vendor#">功能组件(Vendor Package)</a>
        <ul class="nav-ul-two">
          <li class="nav-li-two"><a href="/doc/module/vendor">概述</a></li>
          <li class="nav-li-two"><a href="/doc/module/admin">后台内核(Admin)</a></li>
          <li class="nav-li-two"><a href="/doc/module/upload">上传(Upload)</a></li>
        </ul>
      </li>
    </ul>
  </div>
</div>
<!-- <script type="text/javascript" src="/assets/plugins/jquery-3.4.1.min.js"></script> -->
<script type="text/javascript" src="/assets/plugins/jquery.js"></script>
<script>
  // 打开菜单
  $(".nav-hidden").click(function () {
    $(".nav").css({ right: "0" })
    $(".nav").css({ opacity: "1" })
  })
  // 隐藏菜单
  $(".nav-back").click(function () {
    $(".nav").css({ right: "100%" })
    $(".nav").css({ opacity: "0" })
  })

  $(".nav").click(function (e) {
    if (e.target.className == "nav") {
      $(".nav").css({ right: "100%" })
      $(".nav").css({ opacity: "0" })
    }
  })
</script>
                <div class="doc-content col-md-9 col-12 order-1" style="float: left">
                    <style type="text/css">
  #md-content {
    /* padding-top: 20px; */
    min-height: 500px;
    /* font-family: Consolas, "Liberation Mono", Courier, monospace; */
    font-family: "Helvetica Neue", Helvetica, Arial, "PingFang SC", "Hiragino Sans GB", "Heiti SC", "Microsoft YaHei", "WenQuanYi Micro Hei", sans-serif;
  }

  #md-content h2 {
    /* padding-top: 20px; */
    margin: 30px 0 10px 0;
  }

  #md-content code {
    background: #494d55;
    /* padding: 5px; */
  }

  #md-content .language-plaintext {
    /* padding: 0;
    border-radius: 1em; */
    background: #f9f9fb;
    color: #494d55;
    /* color: #00adef;
    font-weight: normal; */
  }

  #md-content .language-plaintext code {
    background-color: #f9f9fb;
  }

    {
    % if page.img_all==1 %
  }

  #md-content img {
    width: 100%;
    /* max-width: 600px; */
  }

    {
    % endif %
  }

  pre[class*="language-"] {
    padding: 0;
    background: #494d55;
  }

  .update {
    overflow: hidden;
  }

  .doc-section .title {
    float: left;
    width: 70%;
    margin-bottom: 0;
    font-size: 28px;
    line-height: 1.2;
    text-align: left;
    word-break: break-all;
  }

  .time {
    float: right;
    width: 30%;
    padding-top: 14px;
    font-size: 14px;
    line-height: 1;
    text-align: right;
  }

  #a_local_url {
    /* color: #58bbee; */
    color: #f75252;
  }

  .body-blue .a-xy {
    color: #f75252;
  }

  .body-blue .a-xy:hover {
    color: #f75252;
  }

  .nav-bottom {
    width: 100%;
    margin-top: 20px;
  }

  .nav-bottom .prev {
    display: block;
    float: left;
    font-size: 16px;
    line-height: 1.5;
    color: #333;
    text-decoration: underline;
  }

  .nav-bottom .next {
    display: block;
    float: right;
    font-size: 16px;
    line-height: 1.5;
    color: #333;
    text-decoration: underline;
  }

  @media screen and (max-width: 1199px) {
    #md-content>ol {
      padding-left: 3%;
    }

    #md-content>ol>li>ol {
      padding-left: 6%;
    }

    .doc-section .title {
      width: 100%;
    }

    .time {
      width: 100%;
      text-align: left;
    }
  }
</style>
<div class="content-inner">
  <section class="doc-section">
    <div class="update">
      <h2 class="title">高级查询</h2>
      <p class="time"><span>2020-11-05&nbsp;&nbsp;by&nbsp;&nbsp;</span><span id="author"></span>
      </p>
    </div>
    <ul class="a_link"></ul>
    <div id="md-content">
      <h2 id="概述">概述</h2>

<p>高级查询的核心就是规则系统。</p>

<p>规则即查询规则,传入规则,查询系统就会根据规则自动的生成需要的查询<code class="language-plaintext highlighter-rouge">Sql</code>,返回查询结果。</p>

<p>这个理念,不是什么高级的想法,对于<code class="language-plaintext highlighter-rouge">Symfony</code>本身而言,其本身的查询系统,也支持这样去做,并且还有辅助的<code class="language-plaintext highlighter-rouge">IDE</code>提示。</p>

<p>但我还是要说,<code class="language-plaintext highlighter-rouge">PHPZlc</code>的查询系统在<code class="language-plaintext highlighter-rouge">Symfony</code>原有的查询系统上做了一次较大的革新,会给你带来的全新的体验。</p>

<h2 id="架构定义">架构定义</h2>

<ol>
  <li>
    <p>易用性</p>

    <p><code class="language-plaintext highlighter-rouge">Symfony</code>,<code class="language-plaintext highlighter-rouge">Doctrine</code>提供了许多的手段来完成<code class="language-plaintext highlighter-rouge">SQL</code>的构建。在单表查询中,其表现的是十分便捷良好的。</p>

    <p>需要进行连表查询等高级查询的时候,需要学习使用<a href="https://www.doctrine-project.org/projects/doctrine-orm/en/2.7/reference/native-sql.html">Doctrine Native SQL</a>。</p>

    <p>这个知识主要内容就是将表,字段和类,属性进行绑定,完成查询结果对象化的工作。</p>

    <p><code class="language-plaintext highlighter-rouge">PHPZlc</code>认为这个过程是机械繁琐的,这种方式不是未来的方向。并且当下我们已经可以通过<code class="language-plaintext highlighter-rouge">Entity</code>得到了数据库全部的结构,应该可以尝试分析表结构来自动完成这部分工作。</p>
  </li>
  <li>
    <p>资源性</p>

    <p><code class="language-plaintext highlighter-rouge">SQL</code>是系统重要的资源,有些业务逻辑就是<code class="language-plaintext highlighter-rouge">SQL</code>本身。在某种程度上来说,后端的主要工作就是在写<code class="language-plaintext highlighter-rouge">SQL</code>。</p>

    <p>但是现在的情况是,这些重要复杂的资源在系统中却是零散的。零散不是说重要的<code class="language-plaintext highlighter-rouge">SQL</code>没有被复用。而是定义和复用的时候都没有系统的体系,书写者几乎都是在各自为战。</p>

    <p>各自为战是因为架构师的问题么？是规范制定的问题么？我想不是的,主要原因是<code class="language-plaintext highlighter-rouge">SQL</code>作为资源却没有上升到定义的层次。如果一个概念无法简单清晰的被使用者认知,那么任何个体,任何规范都是虚无的。</p>
  </li>
  <li>
    <p>串连性</p>

    <p>实现<code class="language-plaintext highlighter-rouge">SQL</code>资源性,定义的位置好确定,但是易用性却很难解决,要解决易用性的问题,就需要一个体系来完成。</p>

    <p>举个例子,在<code class="language-plaintext highlighter-rouge">User</code>表中定义个<code class="language-plaintext highlighter-rouge">where</code>条件<code class="language-plaintext highlighter-rouge">SQL</code>,那么我在<code class="language-plaintext highlighter-rouge">join user</code>的时候,可以直接使用定义的<code class="language-plaintext highlighter-rouge">where</code>条件么？</p>

    <p>这是个资源通达的问题,解决了这个问题,定义资源才有实质的使用意义。</p>
  </li>
</ol>

<h2 id="父类继承">父类继承</h2>

<p>继承</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">PHPZlc\PHPZlc\Doctrine\ORM\Repository\AbstractServiceEntityRepository</span>
</code></pre></div></div>

<p>这个类的上层继承的还是官方原有的类</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Doctrine\Bundle\DoctrineBundle\Repository\ServiceEntityRepository</span>
</code></pre></div></div>

<p>这里无需手动完成,生成的出来的<code class="language-plaintext highlighter-rouge">Repository</code>类代码会自动继承。</p>

<h2 id="底层策略">底层策略</h2>

<p>最底层的使用逻辑,传入规则,对<code class="language-plaintext highlighter-rouge">SQL</code>的各部分进行字符串拼接,然后连接起来生成完整的<code class="language-plaintext highlighter-rouge">SQL</code>。</p>

<p>主要需要理解两个数组即可,所有的工作都是在其上开展。</p>

<ol>
  <li>
    <p>模版数组</p>

    <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="c1">//在初始化方法中根据Entity结构定义,给数组进行赋值。</span>
 <span class="k">public</span> <span class="nv">$telSqlArray</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
     <span class="s1">'alias'</span> <span class="o">=&gt;</span> <span class="s1">'t'</span><span class="p">,</span>  <span class="c1">//表别名</span>
     <span class="s1">'from'</span> <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">,</span>    <span class="c1">//表名</span>
     <span class="s1">'join'</span> <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">,</span>    <span class="c1">//连表sql部分</span>
     <span class="s1">'select'</span> <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">,</span>  <span class="c1">//查询sql部分</span>
     <span class="s1">'where'</span> <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">,</span>   <span class="c1">//条件sql部分</span>
     <span class="s1">'orderBy'</span> <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">,</span>  <span class="c1">//排序sql部分</span>
     <span class="s1">'finalOrderBy'</span> <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">,</span> <span class="c1">//最终排序sql部分 默认主键ID倒序排列</span>
     <span class="s1">'primaryKey'</span> <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">,</span> <span class="c1">//主键字段</span>
     <span class="s1">'aliasIncrease'</span> <span class="o">=&gt;</span> <span class="s1">'0'</span><span class="p">,</span> <span class="c1">//别名计数器,用于动态计算,此值无需关注</span>
     <span class="s1">'falseDeleteField'</span> <span class="o">=&gt;</span> <span class="s1">''</span> <span class="c1">//假删除字段 系统默认为is_del,bool类型,如果表中存在此字段,则默认赋值</span>
 <span class="p">);</span>
</code></pre></div>    </div>

    <p><em>在初始化方法中根据Entity结构定义,给数组进行赋值。</em></p>

    <p><em>在初始化方法中对其进行修改,将应用于全局。</em></p>

    <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="kt">ManagerRegistry</span> <span class="nv">$registry</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">parent</span><span class="o">::</span><span class="nf">__construct</span><span class="p">(</span><span class="nv">$registry</span><span class="p">,</span> <span class="nc">User</span><span class="o">::</span><span class="n">class</span><span class="p">);</span>

    <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">telSqlArray</span><span class="p">[</span><span class="s1">'from'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'user'</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>执行数组</p>

    <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//执行数组,每次查询时将$telSqlArray值赋予</span>
<span class="k">public</span> <span class="nv">$sqlArray</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">'alias'</span> <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">,</span>
    <span class="s1">'from'</span> <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">,</span>
    <span class="s1">'join'</span> <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">,</span>
    <span class="s1">'select'</span> <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">,</span>
    <span class="s1">'where'</span> <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">,</span>
    <span class="s1">'orderBy'</span> <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">,</span>
    <span class="s1">'finalOrderBy'</span> <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">,</span>
    <span class="s1">'primaryKey'</span> <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">,</span>
    <span class="s1">'aliasIncrease'</span> <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">,</span>
    <span class="s1">'falseDeleteField'</span> <span class="o">=&gt;</span> <span class="s1">''</span>
<span class="p">);</span>
</code></pre></div>    </div>

    <p><em>在每个查询执行前,将 <code class="language-plaintext highlighter-rouge">$telSqlArray</code> 中的内容赋值给 <code class="language-plaintext highlighter-rouge">$sqlArray</code>。</em></p>

    <p><em>我们只需要对<code class="language-plaintext highlighter-rouge">$sqlArray</code>的各部分进行改写,就可以影响最终形成的<code class="language-plaintext highlighter-rouge">SQL</code>。</em></p>
  </li>
  <li>
    <p>拼接算法</p>

    <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">private</span> <span class="k">function</span> <span class="n">generateSql</span><span class="p">()</span>
 <span class="p">{</span>
     <span class="k">return</span> <span class="s2">"SELECT </span><span class="si">{</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">sqlArray</span><span class="p">[</span><span class="s1">'select'</span><span class="p">]</span><span class="si">}</span><span class="s2"> FROM </span><span class="si">{</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">sqlArray</span><span class="p">[</span><span class="s1">'from'</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">sqlArray</span><span class="p">[</span><span class="s1">'alias'</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">sqlArray</span><span class="p">[</span><span class="s1">'join'</span><span class="p">]</span><span class="si">}</span><span class="s2"> WHERE 1 </span><span class="si">{</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">sqlArray</span><span class="p">[</span><span class="s1">'where'</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">sqlArray</span><span class="p">[</span><span class="s1">'orderBy'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">;</span>
 <span class="p">}</span>
</code></pre></div>    </div>

    <p><em>代码中消失的<code class="language-plaintext highlighter-rouge">finalOrderBy</code>会在运用过程中拼接到<code class="language-plaintext highlighter-rouge">orderBy</code>的最后。</em></p>
  </li>
</ol>

<h2 id="当前表别名关键词sql_pre">当前表别名,关键词sql_pre</h2>

<p>表名不会重复,但别名是会重复的。比如 <code class="language-plaintext highlighter-rouge">admin</code> 和 <code class="language-plaintext highlighter-rouge">article</code>,如果将这个独立来看,那么别名都是<code class="language-plaintext highlighter-rouge">a</code>。</p>

<p>这就产生了问题,因为我们在定义<code class="language-plaintext highlighter-rouge">SQL</code>资源的时候,只能知道当前的别名,但是却无法保证别名不会重复。</p>

<p><strong>处理方法</strong></p>

<p>我们规定在定义书写<code class="language-plaintext highlighter-rouge">SQL</code>的时候,定义关键词<code class="language-plaintext highlighter-rouge">sql_pre</code>作为当前表别名的描述词。系统底层演算的时候会自主安排。</p>

<p><strong>实际sql:</strong></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   <span class="k">select</span> <span class="n">u</span><span class="p">.</span><span class="n">id</span> <span class="k">from</span> <span class="k">user</span> <span class="n">u</span>
</code></pre></div></div>

<p><strong>编码时应该为:</strong></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   <span class="k">select</span> <span class="n">sql_pre</span><span class="p">.</span><span class="n">id</span> <span class="k">from</span> <span class="k">user</span> <span class="n">sql_pre</span> 
</code></pre></div></div>

<h2 id="具体如何干预sql">具体如何干预SQL</h2>

<p>读到这里,我们就很清楚,这一套看似很复杂系统的本质,其实是由一个很简单的策略在维持。我们只需要对<code class="language-plaintext highlighter-rouge">$sqlArray</code>的各部分进行改写,就可以影响最终形成的<code class="language-plaintext highlighter-rouge">SQL</code>。</p>

<ol>
  <li>
    <p>通常的<code class="language-plaintext highlighter-rouge">SQL</code>,可以定义规则,触发规则进行改写。</p>

    <p>这里我们不过多的描述规则这个概念,你可以理解他为一组方法,具体可以在后续的规则篇中进行详细说明。</p>
  </li>
  <li>
    <p>部分高级的<code class="language-plaintext highlighter-rouge">SQL</code>过于复杂,需要定制化的处理。</p>

    <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$userRepository</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">getDoctrine</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">getRepository</span><span class="p">(</span><span class="s1">'App:User'</span><span class="p">);</span>
     
<span class="c1">//调用规则处理方法,让系统形成一个基本完成的`$sqlArray`</span>
<span class="nv">$userRepository</span><span class="o">-&gt;</span><span class="nf">rules</span><span class="p">([]);</span>
     
<span class="c1">//对sqlArray进行改写</span>
<span class="nv">$userRepository</span><span class="o">-&gt;</span><span class="n">sqlArray</span><span class="p">[</span><span class="s1">'from'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'user'</span><span class="p">;</span>
     
<span class="c1">//得到sql</span>
<span class="nv">$sql</span> <span class="o">=</span> <span class="nv">$userRepository</span><span class="o">-&gt;</span><span class="nf">getSql</span><span class="p">();</span>
     
<span class="c1">//执行sql,返回的数组,不是对象集合</span>
<span class="nv">$users</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">getDoctrine</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">getConnection</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">fetchAll</span><span class="p">(</span><span class="nv">$sql</span><span class="p">);</span>
</code></pre></div>    </div>
  </li>
</ol>

<h2 id="手动弥补自动化工作的缺陷">手动弥补自动化工作的缺陷</h2>

<p>自动化的绑定工作,是基于<code class="language-plaintext highlighter-rouge">SQL</code>的分析。但是当分析的素材不足的时候,有些绑定工作无法正常完成。这时候需要手动补充。</p>

<p>我们可以使用查询方法中的参数:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">ResultSetMappingBuilder</span> <span class="nv">$resultSetMappingBuilder</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</code></pre></div></div>

<p>使用这个参数,需要学习<a href="https://www.doctrine-project.org/projects/doctrine-orm/en/2.7/reference/native-sql.html">Doctrine Native SQL</a>。</p>

<h2 id="解决别名的冲突">解决别名的冲突</h2>

<p>当我们将子查询定义为<code class="language-plaintext highlighter-rouge">SQL</code>资源的时候,那么就无法避免<code class="language-plaintext highlighter-rouge">子查询</code>中<code class="language-plaintext highlighter-rouge">join</code>其他表。这样不同表中定义的<code class="language-plaintext highlighter-rouge">SQL</code>除了本表的别名被关键词锁定之外,其他连接表的别名就无法避免出现冲突的问题。</p>

<p><strong>处理方法</strong></p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">string</span> <span class="nv">$aliasChain</span> <span class="o">=</span> <span class="s1">''</span>
</code></pre></div></div>

<p><strong>传参格式</strong></p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sql_pre:a=&gt;c,b=&gt;a;at:a=&gt;c,b=&gt;a;
</code></pre></div></div>

<p><strong>格式解析:</strong></p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>表别名1: 目标别名1=&gt;修正别名1;目标别名2=&gt;修正别名2;
</code></pre></div></div>

<h2 id="查询结果对象转数组">查询结果对象转数组</h2>

<ol>
  <li>
    <p>toArray()</p>

    <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">final</span> <span class="k">public</span> <span class="k">function</span> <span class="n">toArray</span><span class="p">(</span><span class="nv">$entity</span><span class="p">,</span> <span class="nv">$params</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'level'</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">]):</span> <span class="kt">array</span>
</code></pre></div>    </div>

    <p><strong>方法解析</strong></p>

    <p>支持一个实体对象传入,对其进行递归,自动调取每个字段属性的<code class="language-plaintext highlighter-rouge">get</code>方法。</p>

    <p><code class="language-plaintext highlighter-rouge">$params</code> 控制参数,可自定义。</p>

    <p><code class="language-plaintext highlighter-rouge">level</code> 递归的层数</p>

    <p>如果对数组格式有特定要求的可以自定义方法,自定义方法要求参数名,参数个数,参数含义和此方法一致。</p>

    <p>例如</p>

    <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">toApiArray</span><span class="p">(</span><span class="nv">$entity</span><span class="p">,</span> <span class="nv">$params</span> <span class="o">=</span> <span class="p">[]);</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">arraySerialization</code> 数据序列化方法</p>

    <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">final</span> <span class="k">public</span> <span class="k">function</span> <span class="n">arraySerialization</span><span class="p">(</span><span class="nv">$result</span><span class="p">,</span> <span class="nv">$decoratorMethodParams</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'level'</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">],</span> <span class="nv">$decoratorMethodName</span> <span class="o">=</span> <span class="s1">'toArray'</span><span class="p">)</span> <span class="p">:</span> <span class="kt">array</span>
</code></pre></div>    </div>

    <p><strong>方法解析</strong></p>

    <p>支持一个对象或者对象集合传入,底层使用调用<code class="language-plaintext highlighter-rouge">toArray</code>。</p>

    <p><code class="language-plaintext highlighter-rouge">$decoratorMethodParams</code>：序列化方法的参数,参照<code class="language-plaintext highlighter-rouge">toArray</code>的<code class="language-plaintext highlighter-rouge">$params</code>参数。</p>

    <p><code class="language-plaintext highlighter-rouge">$decoratorMethodName</code>: 序列化方法的名称。</p>
  </li>
</ol>

<h2 id="规则执行顺序">规则执行顺序</h2>

<ol>
  <li>
    <p>传入规则</p>
  </li>
  <li>
    <p>进行规则演算,加入必要规则和连带规则,且获得实体类和表的关系。</p>
  </li>
  <li>
    <p>运行规则,拼接<code class="language-plaintext highlighter-rouge">Sql</code>。</p>
  </li>
  <li>
    <p>解析<code class="language-plaintext highlighter-rouge">Sql</code>,和实体对照,对查询表,字段进行一一绑定,建立联系,保证查询出来的结果落入的位置是正确的。</p>
  </li>
  <li>
    <p>对<code class="language-plaintext highlighter-rouge">Sql</code>进行最终整理,优化查询速度。</p>
  </li>
  <li>
    <p>执行<code class="language-plaintext highlighter-rouge">Sql</code>返回实体结果。</p>
  </li>
</ol>


      <div class="nav-bottom">
        
        <a class="prev" href="/doc/exception">上一篇</a>
        

        
        <a class="next" href="/doc/repository/rule">下一篇</a>
        
      </div>
    </div>
    <div class="entry-shang text-center">
      <p class="fork_update">找到错别字了？本文档有什么问题么？<a
          href="https://github.com/phpzlc/phpzlc.github.io/edit/master/_posts/doc/2020-11-05-Repository.markdown" target="_blank">分叉并编辑</a> 它&nbsp;！
      </p>
      <button class="zs show-zs btn btn-bred">赞赏</button>
      <!-- <p>「感觉有帮助？对您有价值？开源不易, 一键投喂 牛奶/咖啡/冰阔乐！」</p> -->
    </div>

    <div class="zs-modal-bg"></div>
    <div class="zs-modal-box">
      <div class="zs-modal-head">
        <!-- 关闭按钮 -->
        <button type="button" class="close">×</button>
        <!-- 左上角logo和文字 -->
        <span class="author_zs"> <img src="/assets/images/jay.jpeg" />CJayhe </span>
        <p class="tip"><i></i><span>谢谢您的赞赏~</span></p>
      </div>
      <div class="zs-modal-body">
        <div class="zs-modal-btns">
          <button class="btn btn-blink" data-num="2">2元</button>
          <button class="btn btn-blink" data-num="5">5元</button>
          <button class="btn btn-blink" data-num="10">10元</button>
          <button class="btn btn-blink" data-num="50">50元</button>
          <button class="btn btn-blink" data-num="100">100元</button>
          <button class="btn btn-blink" data-num="1">任意金额</button>
        </div>
        <div class="zs-modal-pay">
          <button class="btn btn-bred" id="pay-text">2元</button>
          <p>使用<span id="pay-type">微信</span>扫描二维码完成支付</p>
          <img src="/assets/images/pay/wechat-btn.png" id="pay-image" />
        </div>
      </div>
      <div class="zs-modal-footer">
        <!-- 赞赏模式，你可以全部打开，也可以选择留一个你喜欢的
                             只需注释掉你想关闭的赞赏模式对应的代码就行，然后再相应的微调一下样式
                        -->
        <!-- 支付宝控件 -->
        <label>
          <input type="radio" name="zs-type" value="alipay" class="zs-type" checked="checked" />
          <span class="zs-alipay"><img src="/assets/images/pay/alipay-btn.png" /></span>
        </label>
        <!-- 微信控件 -->
        <label>
          <input type="radio" name="zs-type" value="wechat" class="zs-type" />
          <span class="zs-wechat"><img src="/assets/images/pay/wechat-btn.png" /></span>
        </label>
        <!-- 清除浮动 -->
        <div class="clear"></div>
      </div>
    </div>
    <div style="font-size: 12px">
      <div>
        <p class="rules">非特殊说明，本站所有文章均为原创，并遵循<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh"
            target="_blank" class="a-xy">CC BY-NC-SA 4.0 协议</a>许可。</p>
        <p class="hidden-xs">转载前请务必署名，本文链接：<a href="" id="a_local_url"></a>。</p>
      </div>
    </div>
  </section>
  <!--//doc-section-->
</div>
<!--//content-inner-->
<script>
  $(function () {
    var title = $("#md-content h2");
    // console.log(title);
    html = '';
    title.each(function () {
      var text = $(this)[0].innerText;
      var id = $(this).eq(0).attr("id");
      // console.log(text, id)
      html += `<li><a href="#${id}">${text}</a></li>`
    })
    $(".a_link").append(html)
  })
</script>
                </div>
            </div><!--//doc-body-->
        </div><!--//container-->
    </div><!--//doc-wrapper-->
    <div id="promo-block" class="promo-block">
  <div class="container">
    <div class="promo-block-inner-bottom">
      <ul class="ul-1">
        <li class="li-1 li-link">
          <p>关联站</p>
          <ul>
            <li><a href="https://github.com/phpzlc/" target="_blank">GitHub 主页</a></li>
            <li><a href="http://symfony.com/" target="_blank">Symfony 官网</a></li>
            <li><a href="http://www.symfonychina.com/" target="_blank">Symfony 中文文档</a></li>
            <li><a href="https://getcomposer.org/" target="_blank">Composer 官网</a></li>
            <li><a href="https://www.doctrine-project.org/projects/doctrine-orm/en/2.7/index.html"
                target="_blank">Doctrine 官网</a></li>
          </ul>
        </li>
        <li class="li-1 li-link">
          <p>热门Blog</p>
          <ul>
            <li><a href="/doc/symfony-flex" target="_blank">Symfony Flex</a></li>
            <li><a href="/doc/db/entity" target="_blank">设计Entity</a></li>
            <li><a href="/blog/9.html" target="_blank">更好的防御BREACH攻击</a></li>
            <li><a href="/blog/5.html" target="_blank">PHP生成全景图(krpano)</a></li>
            <li><a href="/blog/2.html" target="_blank">Git分支参与者的常用操作</a></li>
          </ul>
        </li>
        <li class="li-1 li-community">
          <p>社区支持<span class="community-slack"><a href="/blog/13.html">建立集中高效的开源社区，PHPZlc 核心活动场所 Slack</a></span></p>
          <!-- <span class="community-slack"><a href="/blog/13.html">建立集中高效的开源社区，PHPZlc 核心活动场所 Slack</a></span> -->
          <ul class="community-ul">
            <li class="li-code">
              <div>
                <img src="/assets/images/qq-qun.png">
                <p>扫码加入QQ交流群</p>
              </div>
            </li>
            <li class="li-code">
              <div>
                <img src="/assets/images/zxsjgzh-2.png">
                <p>扫码关注公众号</p>
              </div>
            </li>
            <li class="li-code">
              <div>
                <img src="/assets/images/toutiao-jay.png">
                <p>扫码关注作者头条号</p>
              </div>
            </li>
            <li class="li-code">
              <div>
                <img src="/assets/images/zhihu-1.png">
                <p>扫码关注作者知乎号</p>
              </div>
            </li>
          </ul>
        </li>
      </ul>
      <p style="clear: both">
    </div>
    <!--//promo-block-inner-->
  </div>
  <!--//container-->
</div>
<!--//promo-block-->
</div>
<!--//page-wrapper-->

<footer class="footer text-center">
  <div class="container">
    <!--/* This template is free as long as you keep the footer attribution link. If you'd like to use the template without the attribution link, you can buy the commercial license via our website: themes.3rdwavemedia.com Thank you for your support. :) */-->
    <small class="copyright">该站点设计由 <a href="https://themes.3rdwavemedia.com/" target="_blank">Xiaoying Riley</a> 提供, 由
      <a href="https://pages.github.com/" target="_blank">GitHub Pages</a> 生成。Copyright © <span
        id="copyright-year"></span> by CJayhe. All rights reserved.</small>

  </div>
  <div class="qun">
    <a target="_blank" href="https://jq.qq.com/?_wv=1027&k=ZpwdagVG">
      <img border="0" src="/assets/images/qq.png?v=20210324" alt="一键加群" title="一键加群">
      <!-- <p>关注我们</p>
      <p>点击入群</p> -->
      <p>QQ群</p>
    </a>
    <a class="a-2" target="_blank"
      href="https://join.slack.com/t/phpzlc/shared_invite/zt-r7mxo37k-jamLvYensNjo89eJdrg_7g">
      <img src="/assets/images/slack.png?v=1" alt="一键加群" title="一键加群">
      <!-- <p>关注我们</p>
      <p>点击入群</p> -->
      <p>Slack</p>
    </a>
  </div>
  <!--//container-->
</footer>
<!--//footer-->


<!-- Main Javascript -->
<!-- <script type="text/javascript" src="/assets/plugins/jquery-3.4.1.min.js"></script> -->
<script type="text/javascript" src="/assets/plugins/jquery.js"></script>
<script TYPE="text/javascript" src="/assets/js/reward.js"></script>
<script type="text/javascript" src="/assets/plugins/bootstrap/js/bootstrap.min.js"></script>
<script type="text/javascript" src="/assets/plugins/stickyfill/dist/stickyfill.min.js"></script>
<script type="text/javascript" src="/assets/js/main.js"></script>
<script type="text/javascript" src="/assets/plugins/prism/prism.js"></script>
<script type="text/javascript" src="/assets/plugins/jquery-scrollTo/jquery.scrollTo.min.js"></script>
<script type="text/javascript" src="/assets/plugins/lightbox/dist/ekko-lightbox.min.js"></script>
<script type="text/javascript">
  $(function () {
    $("#a_local_url").text(localBaseUrl());
    $("#a_local_url").attr({ href: localBaseUrl() });


    var date = new Date();
    var year = date.getFullYear();
    $('#copyright-year').text(year);


    $('#left-div a').each(function () {
      var path = window.location.pathname;
      if ($(this).attr("href") == path || $(this).attr("href") == path.substring(0, path.length - 1)) {
        $(this).addClass('a-active');
      }
    })

    $('#author').text(getAuthor('1'));

    $('.author').each(function () {
      $(this).html('作者：' + getAuthor($(this).data('id')));
    });

    function localBaseUrl() {
      return location.protocol + '//' + location.host + location.pathname;
    }
  })
</script>
</body>
</html>